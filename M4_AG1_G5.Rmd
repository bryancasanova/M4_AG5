---
title:    "Ejercicio práctico Clustering"
author: "Bryan Casanova - José Godoy"
date: "20-07-2022"
license:  by-nc-sa
urlcolor: blue
output:
  html_document: 
    theme:        cosmo 
    highlight:    tango 
    toc:          true
    toc_float:    true
    code_folding: show
---

<style>
body {
text-align: justify}
</style>

# 1. Planteamiento del problema

Para este ejercicio nos enfocaremos en los negocios que peor lo están pasando con esta crisis, los pequeños negocios. Las pequeñas empresas representan el 99% de todas las empresas en Estados Unidos y casi el 50% del empleo, así que son un motor indispensable para el desarrollo económico. 

Todos los años, la Administración de Pequeñas Empresas de EE.UU. (SBA) publica una informe anual de la actividad de las pequeñas empresas en cada estado. Para este ejercicio, utilizaremos parte de los datos publicados por este organismo público e intentaremos obtener alguna conclusión mediante el Clustering.

El dataset y el diccionario de datos podrás encontrarlo en la carpeta data.

Así pues, lo primero que haremos es cargar el dataset en R:

```{r,warning=FALSE,message=FALSE}
# Carga paquetes necesarios
require(factoextra)

# Carga el dataset
datos <- read.csv("D:/Master/4.4_Cluster_ejercicio.csv")
head(datos)
```

## 1.1 Preparación del dataset.

Tal y como podrás comprobar, el dataset tiene una dimensión de 51 observaciones (correspondientes a cada uno de los estados federales de USA) y 16 variables (correspondientes a datos económicos relativos a pequeños negocios). Si necesitas más información acerca de qué significa cada variable, podrás encontrarla en el diccionario de datos.

Tal y como podrás comprobar, existen ciertas variables en las cuales hay asteriscos. Estos representan valores nulos (NA). Por tanto, hay que hacer un tratamiento de estas variables para poder aplicar el clustering.

* **Ejercicio 1**: Reemplaza los valores nulos (asteriscos) por la mediana y transforma las variables tratadas a tipo numerico.

```{r}
# Reemplazo los valores nulos por la mediana
# Modifico el tipo de las variables tratadas a numerico
for (i in 2:ncol(datos)){
  datos[,i] <- as.numeric(datos[,i])
  datos[,i][is.na(datos[,i])] <- median(datos[,i], na.rm = T)
}
summary(datos)
```
Observamos que existían 4 columnas que contaban con registros faltantes, los cuales ya fueron reemplazados por la mediana de cada columna.

Una vez realizada la imputación de los valores nulos, es necesario que observes el rango de las variables que vas a utilizar para el clustering y valores si es necesario transformarlas o no.

* **Ejercicio 2**: Crea un nuevo dataframe con todas las variables estandarizadas en el cuál cada fila tenga como nombre cada uno de los estados.

```{r}
# Reescalo las variables creando un nuevo dataframe
datos_scaled <- scale(datos[,-1])
# Añado la variable States como nombre de fila en el nuevo dataframe
rownames(datos_scaled) <- datos$State
# Sumarizo las variables
summary(datos_scaled)
```

## 1.2 Creación de los clusters

Una vez disponemos del dataframe preparado, es necesario estimar el número de clusters óptimo. Pese a que puede ser un proceso subjetivo, existen algunos métodos que pueden ayudarnos a tomar la decisión.

* **Ejercicio 3**: Elige el número de clusters óptimos mediante el método elbow. ¿Observas algún otro número que también podría ser óptimo? Justifica tu respuesta.

```{r}
# Visualización del elbow method
fviz_nbclust(x = datos_scaled, FUNcluster = kmeans, method = "wss", k.max = 15,
             diss = get_dist(datos_scaled, method = "euclidean"), nstart = 50)
```

Al visualizar la curva vemos que aún cuando no se observa un "codo" muy marcado o una reducción de la suma total de varianza intra-cluster sustancial, hay una reducción de la varianza entre los 4 a 6 clusters, por lo que contrastaríamos este resultado con el dendrograma antes de decidir el número de clusters a utilizar.

* **Ejercicio 4**: Elige el número de clusters óptimos mediante la representación del dendrograma. ¿Observas algún otro número que también podría ser óptimo? Justifica tu respuesta.

```{r}
library(factoextra)
# Visualización del dendrograma
set.seed(123)
hc_euclidea_completo <- hclust(d = dist(x = datos_scaled, method = "euclidean"),
                               method = "complete")
fviz_dend(x = hc_euclidea_completo, cex = 0.5, main = "Linkage completo",
          sub = "Distancia euclídea") +
  theme(plot.title =  element_text(hjust = 0.5, size = 15)) +
  geom_hline(yintercept = 8.5, col = "red", linetype = "dashed") +
  geom_hline(yintercept = 9.3, col = "blue", linetype = "dashed") 
```

Visualizando el dendrogramo observamos que se podrían escoger 3 clusters, siguiendo la linea horizontal azul, sin embargo, dado que el estado de Columbia presenta un comportamiento bastante inusual ya que es una rama independiente al resto de los estados, se prefiere utilizar 4 clusters, siguiendo la línea horizontal roja, para representar mejor la variabilidad del resto de los estados.

Una vez tomada la decisión del número de clusters a realizar, procedemos a crear y visualizar los clusters en dos dimensiones.

* **Ejercicio 5**: Crea el número de clusters elegido y representalo en dos dimensiones utilizando la función fviz_cluster.

```{r}
# Creacion de los clusters
set.seed(123)
km_clusters <- kmeans(x = datos_scaled, centers = 4, nstart = 50)

# Visualización de los clusters en 2 dimensiones
fviz_cluster(object = km_clusters, data = datos_scaled, show.clust.cent = TRUE,
             ellipse.type = "euclid", star.plot = TRUE, repel = TRUE) +
  labs(title = "Resultados clustering K-means") +
  theme_bw() +
  theme(legend.position = "none")
```

## 1.3 Interpretación de los clusters

Una vez disponemos de la visualización en dos dimensiones de los estados que pertenecen a cada cluster creado, vamos a la parte interesante, la interpretación de estos.

* **Ejercicio 6**: Elige qué estado consideras que es más representativo de cada cluster. Justifica tu respuesta.

```{r}
# Introduce aquí tu respuesta
print("Tu respuesta")

```

* **Ejercicio 7**: Indexa cada uno de los estados más representativos de cada cluster sobre el dataframe inicial y crea un nuevo tablón de datos en el que únicamente se encuentren estos estados. ¿Qué variables difieren en más en valor entre unos estados y otros?

```{r}
# Selecciono los estados que quiero ver en un vector

# Creo nuevo dataframe sobre el tablon inicial solo con los estados que quiero ver

# Introduce aquí tu respuesta
print("Tu respuesta")

```

* **Ejercicio 8**: ¿Cuál de los estados seleccionados en el ejercicio anterior tiene una tasa de desempleo más elevada?

```{r}
# Introduce aquí tu respuesta
print("Tu respuesta")

```

* **Ejercicio 9**: Si el presidente de los Estados Unidos quisiera lanzar una campaña para aumentar el volumen de exportaciones de pequeños negocios hacia el exterior sobre los estados que menos exportan del país, y con menor valor, qué cluster o clusters le propondrías? (Menciona únicamente el estado que consideres más representativo del cluster)

```{r}
# Introduce aquí tu respuesta
print("Tu respuesta")

```

* **Ejercicio 10**: ¿Qué cluster representa mejor a los pequeños negocios con más ingresos?

```{r}
# Introduce aquí tu respuesta
print("Tu respuesta")

```

## 1.4 Puntuación del del ejercicio

Este ejercicio se puntuará con 10 puntos, siendo el mínimo necesario para superar la prueba de 5 puntos. 
La puntuación es la siguiente:

* Ejercicio 1: 0.5 puntos

* Ejercicio 2: 0.5 puntos

* Ejercicio 3: 1 punto

* Ejercicio 4: 1 punto

* Ejercicio 5: 1.5 puntos

* Ejercicio 6: 1 punto

* Ejercicio 7: 1.5 puntos

* Ejercicio 8: 1 punto

* Ejercicio 9: 1 punto

* Ejercicio 10: 1 punto
